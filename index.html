<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mandarin Flashcards</title>
  <style>
    body { 
      font-family: "Microsoft YaHei", "PingFang SC", "Noto Sans CJK SC", sans-serif; 
      margin: 0; 
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding-top: 100px;
    }
    #answer {
      border: none;
      border-bottom: 2px solid black;
      outline: none;
      font-size: 1.5em;
      text-align: center;
      width: 300px;
      padding: 5px;
      background: transparent;
    }
    #question {
      font-size: 1.5em;
    }
    #faceCanvas {
      display: block;
      margin: 2em auto;
    }
  </style>
</head>
<body>
  <h1 id="title">Mandarin Flashcards</h1>
<div id="setup">
  <p id="instructions">Welcome! Choose your desired settings below, then click start to begin.</p>
  <label for="maxAttempts">Max attempts per card:</label>
  <input type="number" id="maxAttempts" min="1" max="30" value="2"/>
  <br></br>
  <label for="langSelect">Language to respond in:</label>
  <select id="langSelect">
    <option value="">--Select--</option>
    <option value="ch">汉语</option>
    <option value="eng">English</option>
  </select>
  <br></br>
  <label for="deckSelect">Flashcard deck:</label>
  <select id="deckSelect">
    <option value="">--Select--</option>
  </select>
  <br></br>
  <button id="startButton" style="display: none;" onclick="startQuiz()">Start!</button>
</div>
<div id="quiz" style="display: none;">
  <p id="question"></p>
  <input type="text" id="answer" placeholder="" />
  <button id="submitButton" onclick="submitAnswer()" style="font-size: 1.2em; background-color: #007BFF; color: white; padding: 0.5em 1em; border: none; border-radius: 5px;">Enter</button>
  <p id="result"></p>
  <p id="hint" style="font-style: italic; color: gray;"></p>
  <button id="hintButton" style="display: none;" onclick="showHint()">Show Hint</button>
  <button id="giveUpButton" style="display: none;" onclick="giveUp()">Give Up</button>
  <button id="abortButton" onclick="abortQuiz()">Abort</button>
</div>
<button id="playAgainButton" style="display: none; margin-top: 5em;" onclick="resetQuiz()">Play Again</button>
<canvas id="faceCanvas" width="150" height="150" style="margin-top: 5em;"></canvas>

  <script>
    let cards = [];
    let current = 0;
    let lang = 'ch';
    let waitingForNext = false;
    let maxAttempts = 2;

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    // Load CSV file
    fetch('decks.json')
      .then(response => response.json())
      .then(files => {
        const select = document.getElementById('deckSelect');
        files.forEach(file => {
	  const option = document.createElement('option');
	  option.value = file.path;
	  option.textContent = file.topic;
	  select.appendChild(option);
	});
    });
    function loadSelectedFile() {
      updateStartButtonVisibility();
    }
    function updateStartButtonVisibility() {
      const deckSelected = document.getElementById('deckSelect').value;
      const langSelected = document.getElementById('langSelect').value;
      const startButton = document.getElementById('startButton');

      if (deckSelected && langSelected) {
        startButton.style.display = 'inline-block';
      } else {
        startButton.style.display = 'none';
      }
    }
    function startQuiz() {
      const file = document.getElementById('deckSelect').value;
      lang = document.getElementById('langSelect').value;
      maxAttempts = parseInt(document.getElementById('maxAttempts').value) || 5;

      fetch(file)
      .then(response => response.text())
      .then(text => {
        cards = text.trim().split('\n').slice(1).map(line => {
          const [q, a, h] = line.split(',');
          return { question: q.trim(), answer: a.trim(), hint: h.trim(), retries: 0 };
        });

	shuffle(cards);
        current = 0;

        document.getElementById('setup').style.display = 'none';
        document.getElementById('title').style.display = 'none';
        document.getElementById('quiz').style.display = 'block';
        document.getElementById('startButton').style.display = 'none';

        showQuestion();
      })
      .catch(err => {
        document.getElementById('question').textContent = "Error loading file.";
      });
    }
    function showQuestion() {
      if (current < cards.length) {
	const entry = cards[current];
	const prompt = (lang === 'ch') ? entry.question : entry.answer;
        const canvas = document.getElementById('faceCanvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        document.getElementById('question').textContent = prompt;
        document.getElementById('answer').value = '';
        document.getElementById('result').textContent = '';
	document.getElementById('answer').focus();
	document.getElementById('giveUpButton').style.display = 'inline-block';
        document.getElementById('hint').textContent = '';
        if (entry.hint) {
          document.getElementById('hintButton').style.display = 'inline-block';
        } else {
          document.getElementById('hintButton').style.display = 'none';
        }
      } else {
        const canvas = document.getElementById('faceCanvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        document.getElementById('quiz').style.display = 'none';
        document.getElementById('title').textContent = "Deck Complete!";
        document.getElementById('title').style.display = 'block';
        document.getElementById('playAgainButton').style.display = 'inline-block';
      }
    }
    function submitAnswer() {
      if (waitingForNext) {
        waitingForNext = false;
	current++;
	showQuestion();
	return;
      }
      const userAnswer = document.getElementById('answer').value.trim();
      const entry = cards[current];
      const expected = (lang === 'ch') ? entry.answer : entry.question;
      const result = document.getElementById('result');

      if (userAnswer.toLowerCase() === expected.toLowerCase()) {
        result.textContent = "Correct!";
        result.style.color = "green";
	drawFace(true);
	entry.retries = 0;
	waitingForNext = true;
	document.getElementById('giveUpButton').style.display = 'none';
      } else {
	entry.retries++;
	if (entry.retries < maxAttempts) {
	  result.textContent = `Try again. ${maxAttempts - entry.retries} attempts remaining`;
          result.style.color = "red";
          drawFace(false);
	  document.getElementById('answer').value = '';
	  document.getElementById('answer').focus();
	  return;
	} else {
          result.textContent = `Incorrect. The correct answer was: ${expected}`;
          result.style.color = "red";
          drawFace(false);
	  entry.retries = 0;
          waitingForNext = true;
          document.getElementById('giveUpButton').style.display = 'none';
	}
      }
    }
    function showHint() {
      const entry = cards[current];
      if (entry.hint) {
        document.getElementById('hint').textContent = `Hint: ${entry.hint}`;
      }
    }
    function giveUp() {
      const entry = cards[current];
      const expected = (lang === 'ch') ? entry.answer : entry.question;

      const result = document.getElementById('result');
      result.textContent = `The correct answer was: ${expected}`;
      result.style.color = "red";
      entry.retries = 0;
      waitingForNext = true;
      document.getElementById('giveUpButton').style.display = 'none';
    }
    function resetQuiz() {
      document.getElementById('playAgainButton').style.display = 'none';
      document.getElementById('setup').style.display = 'block';
      document.getElementById('title').style.display = 'block';
      document.getElementById('title').textContent = 'Mandarin Flashcards';
      document.getElementById('deckSelect').value = '';
      document.getElementById('langSelect').value = 'ch';
      cards = [];
      current = 0;
      document.getElementById('hint').textContent = '';
      document.getElementById('hintButton').style.display = 'none';
    }
    function abortQuiz() {
      document.getElementById('giveUpButton').style.display = 'none';
      const canvas = document.getElementById('faceCanvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      document.getElementById('quiz').style.display = 'none';
      document.getElementById('hint').textContent = '';
      document.getElementById('hintButton').style.display = 'none';
      resetQuiz();
    }
    function drawFace(isHappy) {
      const canvas = document.getElementById('faceCanvas');
      const ctx = canvas.getContext('2d');

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      ctx.beginPath();
      ctx.arc(75, 75, 70, 0, Math.PI * 2); // big circle
      ctx.fillStyle = '#B07063';
      ctx.fill();
      linewidth = 2;
      ctx.strokeStyle = '#000000';
      ctx.stroke();

      ctx.beginPath();
      ctx.arc(50, 60, 7, 0, Math.PI * 2); // left eye
      ctx.arc(100, 60, 7, 0, Math.PI * 2); // right eye
      ctx.fillStyle = '#000000';
      ctx.fill();

      ctx.beginPath();
      ctx.arc(30, 25, 25, Math.PI * 0.75, Math.PI * 1.8, false); // left ear
      ctx.fillStyle = '#B07063';
      ctx.fill();
      linewidth = 2;
      ctx.strokeStyle = '#000000';
      ctx.stroke();

      ctx.beginPath();
      ctx.arc(120, 25, 25, Math.PI * 0.25, Math.PI * 1.2, true); // right ear
      ctx.fillStyle = '#B07063';
      ctx.fill();
      linewidth = 2;
      ctx.strokeStyle = '#000000';
      ctx.stroke();

      ctx.beginPath();
      ctx.ellipse(75, 85, 9, 6, 0, 0, Math.PI * 2); // nose
      ctx.fillStyle = '#000000';
      ctx.fill();

      // mouth
      if (isHappy) {
        ctx.beginPath();
        ctx.moveTo(75, 89.5);
        ctx.lineTo(75, 97);
        ctx.stroke();
        ctx.beginPath();
        ctx.arc(60, 97, 15, 0, Math.PI, false);
        ctx.stroke();
        ctx.beginPath();
        ctx.arc(90, 97, 15, Math.PI, 0, true); 
        ctx.stroke();
      } else {
        ctx.beginPath();
        ctx.moveTo(75, 89.5);
        ctx.lineTo(75, 99);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(60, 111);
        ctx.lineTo(75, 99);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(75, 99);
        ctx.lineTo(90, 111);
        ctx.stroke();
      }
    }

    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById('deckSelect').addEventListener('change', updateStartButtonVisibility);
      document.getElementById('langSelect').addEventListener('change', updateStartButtonVisibility);

      document.getElementById('answer').addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
          submitAnswer();
        }
      });
    });
  </script>
</body>
</html>
