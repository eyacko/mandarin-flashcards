<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mandarin Flashcards</title>
  <style>
    body { 
      font-family: "Microsoft YaHei", "PingFang SC", "Noto Sans CJK SC", sans-serif; 
      margin: 0; 
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center
    }
    #answer {
      border: none;
      border-bottom: 2px solid black;
      outline: none;
      font-size: 1.5em;
      text-align: center;
      width: 300px;
      padding: 5px;
      background: transparent;
    }
    #question {
      font-size: 1.5em;
    }
    #faceCanvas {
      display: block;
      margin: 2em auto;
    }
  </style>
</head>
<body>
  <h1 id="title">Flashcards</h1>
<div id="setup">
  <p id="instructions">Welcome!</p>
  <label for="maxAttempts">Max attempts per card</label>
  <input type="number" id="maxAttempts" min="1" max="10" value="3" />
  <br></br>
  <label for="modeSelect">Choose language to respond in:</label>
  <select id="modeSelect">
    <option value="">--Select--</option>
    <option value="qa">汉语</option>
    <option value="aq">English</option>
  </select>
  <br></br>
  <label for="fileSelect">Choose a flashcard deck:</label>
  <select id="fileSelect">
    <option value="">--Select--</option>
  </select>
  <br></br>
  <button id="startButton" style="display: none;" onclick="startQuiz()">Start!</button>
</div>
<div id="quiz" style="display: none;">
  <p id="question"></p>
  <input type="text" id="answer" placeholder="" />
  <p id="result"></p>
  <button id="giveUpButton" style="display: none;" onclick="giveUp()">Give Up</button>
</div>
<button id="playAgainButton" style="display: none; margin-top: 5em;" onclick="resetQuiz()">Play Again</button>
<canvas id="faceCanvas" width="150" height="150" style="margin-top: 2em;"></canvas>

  <script>
    let questions = [];
    let current = 0;
    let mode = 'qa';
    let waitingForNext = false;
    let maxAttempts = 5;

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    // Load CSV file
    fetch('decks.json')
      .then(response => response.json())
      .then(files => {
        const select = document.getElementById('fileSelect');
        files.forEach(file => {
	  const option = document.createElement('option');
	  option.value = file.path;
	  option.textContent = file.topic;
	  select.appendChild(option);
	});
    });
    function loadSelectedFile() {
      updateStartButtonVisibility();
    }
    function updateStartButtonVisibility() {
      const fileSelected = document.getElementById('fileSelect').value;
      const modeSelected = document.getElementById('modeSelect').value;
      const startButton = document.getElementById('startButton');

      if (fileSelected && modeSelected) {
        startButton.style.display = 'inline-block';
      } else {
        startButton.style.display = 'none';
      }
    }
    function startQuiz() {
      const file = document.getElementById('fileSelect').value;
      mode = document.getElementById('modeSelect').value;
      maxAttempts = parseInt(document.getElementById('maxAttempts').value) || 5;

      fetch(file)
      .then(response => response.text())
      .then(text => {
        questions = text.trim().split('\n').slice(1).map(line => {
          const [q, a] = line.split(',');
          return { question: q, answer: a.trim(), retries: 0 };
        });

	shuffle(questions);
        current = 0;

        document.getElementById('setup').style.display = 'none';
        document.getElementById('title').style.display = 'none';
        document.getElementById('quiz').style.display = 'block';
        document.getElementById('startButton').style.display = 'none';

        showQuestion();
      })
      .catch(err => {
        document.getElementById('question').textContent = "Error loading file.";
      });
    }
    function showQuestion() {
      if (current < questions.length) {
	const entry = questions[current];
	const prompt = (mode === 'qa') ? entry.question : entry.answer;
        const canvas = document.getElementById('faceCanvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        document.getElementById('question').textContent = prompt;
        document.getElementById('answer').value = '';
        document.getElementById('result').textContent = '';
	document.getElementById('answer').focus();
	document.getElementById('giveUpButton').style.display = 'inline-block';
      } else {
        const canvas = document.getElementById('faceCanvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        document.getElementById('quiz').style.display = 'none';
        document.getElementById('playAgainButton').style.display = 'inline-block';
        document.getElementById('title').textContent = "Quiz Complete!";
      }
    }
    function submitAnswer() {
      if (waitingForNext) {
        waitingForNext = false;
	current++;
	showQuestion();
	return;
      }
      const userAnswer = document.getElementById('answer').value.trim();
      const entry = questions[current];
      const expected = (mode === 'qa') ? entry.answer : entry.question;

      const result = document.getElementById('result');

      if (userAnswer.toLowerCase() === expected.toLowerCase()) {
        result.textContent = "Correct!";
        result.style.color = "green";
	drawFace(true);
	entry.retries = 0;
	waitingForNext = true;
	document.getElementById('giveUpButton').style.display = 'none';
      } else {
	entry.retries++;
	if (entry.retries < maxAttempts) {
	  result.textContent = `Try again. ${maxAttempts - entry.retries} attempts remaining`;
          result.style.color = "red";
          drawFace(false);
	  document.getElementById('answer').value = '';
	  document.getElementById('answer').focus();
	  return;
	} else {
          result.textContent = `Incorrect. The correct answer was: ${expected}`;
          result.style.color = "red";
          drawFace(false);
	  entry.retries = 0;
          waitingForNext = true;
          document.getElementById('giveUpButton').style.display = 'none';
	}
      }
      current++;
    }
    function giveUp() {
      const entry = questions[current];
      const expected = (mode === 'qa') ? entry.answer : entry.question;

      const result = document.getElementById('result');
      result.textContent = `The correct answer was: ${expected}`;
      result.style.color = "red";
      entry.retries = 0;
      waitingForNext = true;
      document.getElementById('giveUpButton').style.display = 'none';
    }
    function resetQuiz() {
      document.getElementById('playAgainButton').style.display = 'none';
      document.getElementById('setup').style.display = 'block';
      document.getElementById('title').style.display = 'block';
      document.getElementById('title').textContent = 'Flashcards';
      document.getElementById('fileSelect').value = '';
      document.getElementById('modeSelect').value = 'qa';
      questions = [];
      current = 0;
    }
    function drawFace(isHappy) {
      const canvas = document.getElementById('faceCanvas');
      const ctx = canvas.getContext('2d');

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      ctx.beginPath();
      ctx.arc(75, 75, 70, 0, Math.PI * 2); // big circle
      ctx.stroke();

      ctx.beginPath();
      ctx.arc(50, 55, 7, 0, Math.PI * 2); // left eye
      ctx.arc(100, 55, 7, 0, Math.PI * 2); // right eye
      ctx.fill();

      ctx.beginPath();
      if (isHappy) {
        ctx.arc(75, 85, 35, 0, Math.PI, false); // smile
      } else {
        ctx.arc(75, 105, 35, 0, Math.PI, true); // frown
      }
      ctx.stroke();
    }

    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById('fileSelect').addEventListener('change', updateStartButtonVisibility);
      document.getElementById('modeSelect').addEventListener('change', updateStartButtonVisibility);

      document.getElementById('answer').addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
          submitAnswer();
        }
      });
    });
  </script>
</body>
</html>
